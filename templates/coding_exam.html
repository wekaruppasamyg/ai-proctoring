<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coding Exam ‚Äì {{ language }} | AI Proctor</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
<!-- CodeMirror -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/php/php.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
<!-- CodeMirror addons -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>

<style>
:root{
    --bg:#0a0e1a;
    --surface:#111827;
    --surface2:#1f2937;
    --primary:#8b5cf6;
    --accent:#22d3ee;
    --green:#10b981;
    --red:#ef4444;
    --text:#e5e7eb;
    --muted:#6b7280;
    --border:rgba(255,255,255,0.08);
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
body{background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}

/* HEADER */
header{
    position:fixed;top:0;left:0;right:0;z-index:200;
    background:rgba(10,14,26,0.9);backdrop-filter:blur(16px);
    border-bottom:1px solid var(--border);padding:12px 24px;
    display:flex;align-items:center;justify-content:space-between;
}
.logo{display:flex;align-items:center;gap:10px;}
.logo span{font-size:18px;font-weight:600;color:var(--primary);}
.header-right{display:flex;align-items:center;gap:14px;}
.lang-badge{background:rgba(139,92,246,0.2);border:1px solid rgba(139,92,246,0.4);color:#c4b5fd;padding:5px 14px;border-radius:20px;font-size:13px;font-weight:500;}
.username-badge{background:rgba(34,211,238,0.1);border:1px solid rgba(34,211,238,0.3);color:#67e8f9;padding:5px 14px;border-radius:20px;font-size:13px;}

/* ALERTS */
#cheat-alert{
    display:none;position:fixed;top:70px;left:50%;transform:translateX(-50%);
    background:rgba(239,68,68,0.95);color:#fff;padding:10px 24px;border-radius:30px;
    font-size:14px;font-weight:500;z-index:300;box-shadow:0 8px 24px rgba(239,68,68,0.5);
}

/* LAYOUT */
.layout{
    display:grid;
    grid-template-columns:1fr 300px;
    grid-template-rows:auto 1fr auto;
    gap:0;
    height:100vh;
    padding-top:58px;
}

/* EDITOR PANEL */
.editor-panel{
    display:flex;flex-direction:column;
    background:var(--surface);
    border-right:1px solid var(--border);
}
.editor-toolbar{
    display:flex;align-items:center;justify-content:space-between;
    padding:10px 16px;
    border-bottom:1px solid var(--border);
    background:var(--surface2);
    flex-shrink:0;
}
.editor-toolbar-left{display:flex;align-items:center;gap:10px;}
.file-indicator{font-size:13px;color:var(--muted);}
.file-indicator span{color:var(--accent);}
.toolbar-btns{display:flex;gap:10px;}
.btn{padding:8px 18px;border:none;border-radius:20px;font-size:13px;font-weight:500;cursor:pointer;transition:.25s;display:flex;align-items:center;gap:6px;}
.btn-run{background:linear-gradient(135deg,var(--green),#059669);color:#fff;}
.btn-run:hover{transform:scale(1.04);box-shadow:0 6px 18px rgba(16,185,129,0.4);}
.btn-submit{background:linear-gradient(135deg,var(--primary),#6366f1);color:#fff;}
.btn-submit:hover{transform:scale(1.04);box-shadow:0 6px 18px rgba(139,92,246,0.4);}
.btn-clear{background:rgba(255,255,255,0.07);color:var(--muted);border:1px solid var(--border);}
.btn-clear:hover{background:rgba(255,255,255,0.12);color:var(--text);}

.CodeMirror{
    height:100%;
    font-size:14px;
    font-family:'JetBrains Mono','Fira Code','Courier New',monospace !important;
    background:#282a36 !important;
    flex:1;
}
.cm-wrapper{flex:1;overflow:hidden;display:flex;flex-direction:column;}
.CodeMirror-scroll{height:100%;}

/* OUTPUT PANEL */
.output-panel{
    background:#1a1a2e;
    border-top:2px solid var(--border);
    flex-shrink:0;
    height:200px;
    display:flex;flex-direction:column;
}
.output-header{
    padding:8px 16px;
    background:var(--surface2);
    border-bottom:1px solid var(--border);
    font-size:12px;font-weight:600;color:var(--muted);
    display:flex;align-items:center;justify-content:space-between;
    text-transform:uppercase;letter-spacing:.8px;
}
.output-status{font-size:11px;text-transform:none;letter-spacing:0;}
.output-status.ok{color:var(--green);}
.output-status.err{color:var(--red);}
.output-status.running{color:var(--accent);}
#output-text{
    flex:1;overflow-y:auto;padding:12px 16px;
    font-family:'JetBrains Mono','Courier New',monospace;
    font-size:13px;line-height:1.6;white-space:pre-wrap;color:#a3e635;
}
#output-text.error-text{color:var(--red);}

/* BROWSER OUTPUT IFRAME */
#browser-output{
    display:none;width:100%;height:100%;border:none;background:#fff;flex:1;
}

/* SIDEBAR: CAMERA + INFO */
.sidebar{
    background:var(--surface);
    border-left:1px solid var(--border);
    display:flex;flex-direction:column;
    overflow-y:auto;
}
.cam-section{padding:16px;}
.cam-label{font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px;}
.cam-wrapper{position:relative;border-radius:14px;overflow:hidden;background:#000;aspect-ratio:4/3;}
#video{width:100%;height:100%;object-fit:cover;display:block;}
#canvas{display:none;}
.cam-status{
    position:absolute;bottom:8px;left:50%;transform:translateX(-50%);
    background:rgba(0,0,0,0.7);color:var(--green);font-size:11px;
    padding:3px 10px;border-radius:10px;white-space:nowrap;
}
.cam-status.warning{color:var(--red);}
#camera-hidden-msg{
    display:none;
    position:absolute;inset:0;
    background:rgba(239,68,68,0.85);
    display:none;align-items:center;justify-content:center;
    border-radius:14px;font-size:13px;text-align:center;padding:12px;
    color:#fff;font-weight:500;
}

.info-section{padding:0 16px 16px;}
.info-card{
    background:var(--surface2);border-radius:12px;padding:14px;
    border:1px solid var(--border);margin-bottom:10px;
}
.info-card-title{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.7px;margin-bottom:6px;}
.info-card-value{font-size:14px;font-weight:500;}
.info-card-value.warn{color:var(--red);}

.violation-row{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);padding:3px 0;}
.violation-count{color:var(--text);font-weight:500;}
.violation-count.has-violations{color:var(--red);}

/* BLOCK OVERLAY */
#block-overlay{
    display:none;position:fixed;inset:0;
    background:rgba(0,0,0,0.88);z-index:9999;
    align-items:center;justify-content:center;flex-direction:column;gap:12px;
}
#block-overlay h2{color:#fff;font-size:2rem;text-align:center;}
#block-overlay p{color:#9ca3af;font-size:1rem;text-align:center;}

/* SUCCESS MODAL */
#success-modal{
    display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);
    z-index:9998;align-items:center;justify-content:center;
}
.success-card{
    background:var(--surface);border:1px solid rgba(16,185,129,0.4);
    border-radius:24px;padding:48px 40px;text-align:center;max-width:420px;
    box-shadow:0 30px 80px rgba(0,0,0,0.5);animation:fadeUp .4s ease;
}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
.success-card .icon{font-size:64px;margin-bottom:16px;}
.success-card h2{font-size:22px;font-weight:600;color:var(--green);margin-bottom:8px;}
.success-card p{color:var(--muted);font-size:14px;margin-bottom:24px;}
.success-card a{
    display:inline-block;padding:12px 30px;border-radius:30px;
    background:linear-gradient(135deg,var(--primary),#6366f1);color:#fff;
    text-decoration:none;font-weight:500;font-size:14px;
    transition:.3s;
}
.success-card a:hover{transform:scale(1.04);box-shadow:0 8px 24px rgba(139,92,246,0.4);}

/* SPINNER */
.spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* RESPONSIVE */
@media(max-width:900px){
    .layout{grid-template-columns:1fr;}
    .sidebar{display:none;}
}
</style>
</head>
<body>

<!-- HEADER -->
<header>
    <div class="logo">
        <span>üñ•Ô∏è AI Proctor ‚Äì Coding Exam</span>
    </div>
    <div class="header-right">
        <span class="lang-badge">{{ language }}</span>
        <span class="username-badge">{{ username }}</span>
    </div>
</header>

<!-- CHEAT ALERT -->
<div id="cheat-alert">‚ö†Ô∏è Cheating detected!</div>

<!-- BLOCK OVERLAY -->
<div id="block-overlay">
    <h2>‚ö†Ô∏è Exam Blocked</h2>
    <p>Another person or cheating activity detected.<br>Please ensure only you are visible to continue.</p>
</div>

<!-- SUCCESS MODAL -->
<div id="success-modal" style="display:flex;display:none;">
    <div class="success-card">
        <div class="icon">üéâ</div>
        <h2>Exam Submitted!</h2>
        <p>Your code has been saved successfully.<br>Thank you for completing the coding exam.</p>
        <a href="/student-dashboard">‚Üê Back to Dashboard</a>
    </div>
</div>

<!-- MAIN LAYOUT -->
<div class="layout">

    <!-- LEFT: EDITOR + OUTPUT -->
    <div class="editor-panel">
        <!-- TOOLBAR -->
        <div class="editor-toolbar">
            <div class="editor-toolbar-left">
                <span class="file-indicator">main.<span id="ext">py</span></span>
            </div>
            <div class="toolbar-btns">
                <button class="btn btn-clear" onclick="clearEditor()">üóë Clear</button>
                <button class="btn btn-run" id="run-btn" onclick="runCode()">‚ñ∂ Run</button>
                <button class="btn btn-submit" onclick="submitCode()">‚úÖ Submit</button>
            </div>
        </div>

        <!-- CODE MIRROR EDITOR -->
        <div class="cm-wrapper">
            <textarea id="editor">{{ starter_code | default('') }}</textarea>
        </div>

        <!-- OUTPUT -->
        <div class="output-panel">
            <div class="output-header">
                <span>Output</span>
                <span class="output-status" id="output-status"></span>
            </div>
            <pre id="output-text">// Run your code to see output here...</pre>
            <iframe id="browser-output" sandbox="allow-scripts"></iframe>
        </div>
    </div>

    <!-- RIGHT: CAMERA + VIOLATIONS -->
    <div class="sidebar">
        <div class="cam-section">
            <div class="cam-label">üì∑ Live Camera Monitor</div>
            <div class="cam-wrapper">
                <video id="video" autoplay muted playsinline></video>
                <canvas id="canvas" width="320" height="240"></canvas>
                <div id="camera-hidden-msg">üì∑ Camera Hidden<br>Please uncover your camera</div>
                <div class="cam-status" id="cam-status-dot">‚óè Live</div>
            </div>
        </div>

        <div class="info-section">
            <div class="info-card">
                <div class="info-card-title">Language</div>
                <div class="info-card-value">{{ language }}</div>
            </div>
            <div class="info-card">
                <div class="info-card-title">Student</div>
                <div class="info-card-value">{{ username }}</div>
            </div>
            <div class="info-card">
                <div class="info-card-title">Violations</div>
                <div class="violation-row"><span>Look Away</span><span class="violation-count" id="v-look">0</span></div>
                <div class="violation-row"><span>Tab Switch</span><span class="violation-count" id="v-tab">0</span></div>
                <div class="violation-row"><span>Camera Hidden</span><span class="violation-count" id="v-cam">0</span></div>
                <div class="violation-row"><span>Hand Cover</span><span class="violation-count" id="v-hand">0</span></div>
                <div class="violation-row"><span>Multi-Person</span><span class="violation-count" id="v-cheat">0</span></div>
            </div>
        </div>
    </div>

</div>

<!-- CODEMIRROR INIT + APP JS -->
<script>
const LANGUAGE = "{{ language }}";
const USERNAME = "{{ username }}";

// Map language ‚Üí CodeMirror mode + file ext
const langConfig = {
    "Python":     { mode: "python",     ext: "py",   starter: '# Write your Python code here\nprint("Hello, World!")\n' },
    "HTML":       { mode: "htmlmixed",  ext: "html", starter: '<!DOCTYPE html>\n<html>\n<head><title>My Page</title></head>\n<body>\n  <h1>Hello, World!</h1>\n</body>\n</html>\n' },
    "JavaScript": { mode: "javascript", ext: "js",   starter: '// Write your JavaScript code here\nconsole.log("Hello, World!");\n' },
    "PHP":        { mode: "php",        ext: "php",  starter: '<?php\n// Write your PHP code here\necho "Hello, World!";\n?>\n' },
};

const cfg = langConfig[LANGUAGE] || langConfig["Python"];
document.getElementById("ext").textContent = cfg.ext;
document.querySelector('#editor').value = cfg.starter;

// Init CodeMirror
const editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
    mode: cfg.mode,
    theme: "dracula",
    lineNumbers: true,
    matchBrackets: true,
    autoCloseBrackets: true,
    indentUnit: 4,
    tabSize: 4,
    indentWithTabs: LANGUAGE === "Python" ? false : false,
    extraKeys: {"Tab": "indentMore", "Shift-Tab": "indentLess"},
    lineWrapping: false,
});
editor.setSize("100%", "100%");

// =========== RUN CODE ===========
let lastOutput = "";

function runCode() {
    const code = editor.getValue();
    const btn = document.getElementById("run-btn");
    const statusEl = document.getElementById("output-status");
    const outputEl = document.getElementById("output-text");
    const iframeEl = document.getElementById("browser-output");

    btn.innerHTML = '<span class="spinner"></span> Running‚Ä¶';
    btn.disabled = true;
    statusEl.textContent = "running‚Ä¶";
    statusEl.className = "output-status running";

    fetch("/run-code", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({language: LANGUAGE, code: code})
    })
    .then(r => r.json())
    .then(data => {
        btn.innerHTML = "‚ñ∂ Run";
        btn.disabled = false;

        if (data.type === "browser") {
            // HTML or JS ‚Üí render in iframe
            outputEl.style.display = "none";
            iframeEl.style.display = "block";

            let content = data.code;
            if (LANGUAGE === "JavaScript") {
                content = `<!DOCTYPE html><html><head><style>body{font-family:sans-serif;padding:10px;}</style></head><body><script>\n${data.code}\n<\/script></body></html>`;
            }
            iframeEl.srcdoc = content;
            lastOutput = "[Rendered in browser preview]";
            statusEl.textContent = "‚úì Rendered";
            statusEl.className = "output-status ok";
        } else {
            outputEl.style.display = "block";
            iframeEl.style.display = "none";
            const out = data.output || "(no output)";
            lastOutput = out;
            outputEl.textContent = out;
            if (data.is_error) {
                outputEl.className = "error-text";
                statusEl.textContent = "‚úó Error";
                statusEl.className = "output-status err";
            } else {
                outputEl.className = "";
                statusEl.textContent = "‚úì Success";
                statusEl.className = "output-status ok";
            }
        }
    })
    .catch(err => {
        btn.innerHTML = "‚ñ∂ Run";
        btn.disabled = false;
        outputEl.textContent = "Network error: " + err;
        outputEl.className = "error-text";
        statusEl.textContent = "‚úó Error";
        statusEl.className = "output-status err";
    });
}

// =========== SUBMIT ===========
function submitCode() {
    if (!confirm("Submit your code? This cannot be undone.")) return;
    const code = editor.getValue();

    fetch("/submit-coding-exam", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({language: LANGUAGE, code: code, output: lastOutput})
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === "ok") {
            document.getElementById("success-modal").style.display = "flex";
        } else {
            alert("Submission error: " + (data.message || "Unknown error"));
        }
    })
    .catch(() => alert("Network error during submission."));
}

// =========== CLEAR ===========
function clearEditor() {
    if (confirm("Clear the editor?")) {
        editor.setValue(cfg.starter);
        editor.clearHistory();
    }
}

// =========== CAMERA MONITORING (same as MCQ exam) ===========
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const cheatAlert = document.getElementById("cheat-alert");
const cameraHiddenMsg = document.getElementById("camera-hidden-msg");
const blockOverlay = document.getElementById("block-overlay");

// Violation counters
let vLook = 0, vTab = 0, vCam = 0, vHand = 0, vCheat = 0;
function updateViolationUI() {
    document.getElementById("v-look").textContent = vLook;
    document.getElementById("v-tab").textContent = vTab;
    document.getElementById("v-cam").textContent = vCam;
    document.getElementById("v-hand").textContent = vHand;
    document.getElementById("v-cheat").textContent = vCheat;
    ["v-look","v-tab","v-cam","v-hand","v-cheat"].forEach(id => {
        const el = document.getElementById(id);
        el.classList.toggle("has-violations", parseInt(el.textContent) > 0);
    });
}

// Start camera
navigator.mediaDevices.getUserMedia({video: true, audio: false})
    .then(stream => { video.srcObject = stream; })
    .catch(() => {
        document.getElementById("cam-status-dot").textContent = "‚óè No Camera";
        document.getElementById("cam-status-dot").classList.add("warning");
    });

function isCameraHidden(canvas) {
    const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
    let total = 0;
    for (let i = 0; i < data.length; i += 4) total += data[i];
    return (total / (data.length / 4)) < 50;
}

// Monitor every 5 seconds
setInterval(() => {
    if (!video.srcObject) return;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    if (isCameraHidden(canvas)) {
        cameraHiddenMsg.style.display = "flex";
        fetch("/monitor-exam", {method:"POST", headers:{"Content-Type":"application/json"},
            body: JSON.stringify({event:"camera_hidden"})})
            .then(r => r.json()).then(d => { vCam = d.camera_hidden_count || vCam; updateViolationUI(); });
        return;
    } else {
        cameraHiddenMsg.style.display = "none";
    }

    const imageData = canvas.toDataURL("image/jpeg");
    fetch("/monitor-exam", {method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({image: imageData})})
    .then(r => r.json())
    .then(data => {
        if (data.status === "cheating") {
            vCheat = data.cheating_count || vCheat;
            updateViolationUI();
            cheatAlert.innerHTML = `‚ùå Multiple people detected! Count: ${data.cheating_count}/10`;
            cheatAlert.style.display = "block";
            blockOverlay.style.display = "flex";
        } else if (data.status === "terminated") {
            cheatAlert.innerHTML = `‚ùå Exam terminated!`;
            cheatAlert.style.display = "block";
            blockOverlay.style.display = "flex";
            alert("Your coding exam has been terminated due to cheating.");
        } else if (data.status === "look-away") {
            vLook = data.looking_away_count || vLook;
            updateViolationUI();
            cheatAlert.style.display = "none";
            blockOverlay.style.display = "none";
        } else {
            cheatAlert.style.display = "none";
            blockOverlay.style.display = "none";
        }
    });
}, 5000);

// MJPEG live stream to admin
function sendLiveFrame() {
    if (!video.srcObject) { setTimeout(sendLiveFrame, 200); return; }
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    canvas.toBlob(blob => {
        if (blob) {
            fetch("/upload-frame", {method:"POST", body:blob})
                .finally(() => setTimeout(sendLiveFrame, 120));
        } else {
            setTimeout(sendLiveFrame, 120);
        }
    }, "image/jpeg");
}
sendLiveFrame();

// =========== TAB VISIBILITY ===========
document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
        vTab++;
        updateViolationUI();
        fetch("/tab-switch", {method:"POST"});
        alert("‚ö† Tab switching detected during coding exam!");
    }
});

// =========== KEYBOARD RESTRICTIONS ===========
document.addEventListener("contextmenu", e => e.preventDefault());
document.addEventListener("keydown", e => {
    // Allow normal coding keys - only block DevTools / refresh
    if (e.key === "F12" || (e.ctrlKey && e.shiftKey && e.key === "I")) {
        e.preventDefault();
        alert("‚ö† DevTools are disabled during the exam!");
    }
    if (e.key === "F5" || (e.ctrlKey && e.key === "r")) {
        e.preventDefault();
        alert("‚ö† Refreshing is not allowed during the exam!");
    }
});
</script>
</body>
</html>
